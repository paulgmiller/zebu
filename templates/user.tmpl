<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>{{ .UserPublicName }}</title>
		<link href="/static/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3">
        <script src="/static/web3.min.js"></script>
    </head>
	<body>
	    <nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container">
				<a class="navbar-brand" href="#">Zebu</a>
				<button id="connect-btn" class="btn btn-primary" disable=true>{{ .UserId}}</button>
			</div>
    	</nav>
		<div><a href="/user/{{ .UserPublicName }}">{{ .UserId }}</a>(ask friends to follow {{ .UserPublicName }})</div>
		<br />
		<!-- only show if no name is set -->
		<form onsubmit="register(event)" >
			<textarea name="register" rows="1" cols="64"></textarea>
			<br/>
			<input type="submit" value="Register">
		</form>
		<form onsubmit="savepost(event)" >
			<textarea id="post-text" name="post" rows="12" cols="100"></textarea>
			<br/>
			<input type="file" name="images" accept="image/*" multiple> 
			<br/>
			<input type="submit" value="Submit">
		</form >
		<form onsubmit="follow(event)" >
			<textarea name="followee" rows="1" cols="64"></textarea>
			<br/>
			<input type="submit" value="Follow">
		</form>
		<div name="output" ></div>
		<br/>
		{{range .Posts}}
		<div>{{ .RenderedContent }}</div>
		{{range .Images}}
		<img src="/img/{{.}}" width="100"/>
		{{end}}
		<div><a href="/user/{{ .AuthorPublicName }}">{{ .AuthorPublicName }}</a> at {{ .Created }}</div>
		<br />		
        {{else}}
        <div><strong>No Posts</strong></div>
        {{end}}
		<!-- credit view-source:https://shobhitic.github.io/ethsign/ -->
		<script type="text/javascript">
		var account = "{{ .UserId }}"
		window.w3 = new Web3(window.ethereum)
		const savepost = async (event) => {
			event.preventDefault()
			var formData = new FormData(event.target)
			formData.append("account", account)
			console.log(formData)
			var response = await fetch("post", { method: "POST", body: formData}  )
			var r2 = response.clone()
			var data = await response.json()
			//error if data already has signature?
			var rawjson = await r2.text()
			console.log("rawjson: " + rawjson)
			var signature = await w3.eth.personal.sign(rawjson, account)
			data.Signature = signature
			console.log(data)
			response = await fetch("/sign", { method: "POST", body: JSON.stringify(data)}  )
			console.log(response)
			location.reload()
		}
		const follow = async (event) => {
			event.preventDefault()
			var formData = new FormData(event.target)
			formData.append("account", account)
			console.log(formData)
			var response = await fetch("/follow", { method: "POST", body: formData}  )
			var r2 = response.clone()
			var data = await response.json()
			var rawjson = await r2.text()
			console.log("rawjson: " + rawjson)
			var signature = await w3.eth.personal.sign(rawjson, account)
			data.Signature = signature
			console.log(data)
			response = await fetch("/sign", { method: "POST", body: JSON.stringify(data)}  )
			console.log(response)
			location.reload()
		}

		const register = async (event) => {
			event.preventDefault()
			var formData = new FormData(event.target)
			formData.append("account", account)
			console.log(formData)
			var response = await fetch("/register", { method: "POST", body: formData}  )
			var r2 = response.clone()
			var data = await response.json()
			var rawjson = await r2.text()
			console.log("rawjson: " + rawjson)
			var signature = await w3.eth.personal.sign(rawjson, account)
			data.Signature = signature
			console.log(data)
			response = await fetch("/sign", { method: "POST", body: JSON.stringify(data)}  )
			console.log(response)
			location.reload()
		}
    </script>
	</body>
</html>